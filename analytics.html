<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baiddy — Analytics Dashboard</title>
    <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=aeonik@400,500,600,700&display=swap">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --terracotta: #e459db;
            --terracotta-light: #ec7ee5;
            --amber: #b559e4;
            --amber-light: #c97eed;
            --accent: #dbe459;
            --navy: #1C1E2E;
            --navy-mid: #2A2D42;
            --navy-light: #353954;
            --navy-surface: #232640;
            --cream: #FBF5EC;
            --cream-dark: #F0E6D6;
            --text-primary: #E8E6F0;
            --text-secondary: #9896A8;
            --text-muted: #6B6980;
            --border: rgba(255,255,255,0.06);
            --border-light: rgba(255,255,255,0.1);
            --green: #59e4a0;
            --red: #e45968;
            --orange: #e4a059;
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --shadow: 0 4px 24px rgba(0,0,0,0.3);
            --glow-pink: 0 0 40px rgba(228,89,219,0.15);
            --glow-purple: 0 0 40px rgba(181,89,228,0.15);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Aeonik', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--navy);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== BACKGROUND ATMOSPHERE ===== */
        body::before {
            content: '';
            position: fixed;
            top: -30%; left: -20%;
            width: 70%; height: 70%;
            background: radial-gradient(ellipse, rgba(228,89,219,0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        body::after {
            content: '';
            position: fixed;
            bottom: -20%; right: -15%;
            width: 60%; height: 60%;
            background: radial-gradient(ellipse, rgba(181,89,228,0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* ===== NOISE TEXTURE ===== */
        .noise {
            position: fixed; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--navy-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ===== LAYOUT ===== */
        .dashboard {
            position: relative;
            z-index: 1;
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 24px 60px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo-mark {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--terracotta), var(--amber));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; color: #fff;
            box-shadow: var(--glow-pink);
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        .header-title span {
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 8px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .live-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(89,228,160,0.1);
            border: 1px solid rgba(89,228,160,0.2);
            font-size: 13px;
            font-weight: 500;
            color: var(--green);
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        .live-badge:hover { background: rgba(89,228,160,0.15); }
        .live-badge.inactive {
            background: rgba(255,255,255,0.04);
            border-color: var(--border-light);
            color: var(--text-muted);
        }
        .live-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse-dot 2s infinite;
        }
        .live-badge.inactive .live-dot {
            background: var(--text-muted);
            animation: none;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }
        .btn-refresh {
            padding: 7px 16px;
            border-radius: 8px;
            background: var(--navy-surface);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-refresh:hover { background: var(--navy-light); color: var(--text-primary); }
        .btn-refresh svg { width: 14px; height: 14px; }
        .btn-refresh.loading svg { animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== KPI CARDS ===== */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        .kpi-card {
            background: var(--navy-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s, transform 0.2s;
        }
        .kpi-card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px);
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            border-radius: 2px 2px 0 0;
        }
        .kpi-card:nth-child(1)::before { background: var(--terracotta); }
        .kpi-card:nth-child(2)::before { background: var(--amber); }
        .kpi-card:nth-child(3)::before { background: var(--accent); }
        .kpi-card:nth-child(4)::before { background: var(--green); }
        .kpi-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1;
        }
        .kpi-card:nth-child(1) .kpi-value { color: var(--terracotta-light); }
        .kpi-card:nth-child(2) .kpi-value { color: var(--amber-light); }
        .kpi-card:nth-child(3) .kpi-value { color: var(--accent); }
        .kpi-card:nth-child(4) .kpi-value { color: var(--green); }
        .kpi-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* ===== SECTION PANELS ===== */
        .panel {
            background: var(--navy-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .panel:hover { border-color: var(--border-light); }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .panel-title {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        .panel-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
        }

        /* ===== FILTERS ===== */
        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 28px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .filter-select, .filter-input {
            background: var(--navy-surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            padding: 7px 12px;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }
        .filter-select:focus, .filter-input:focus {
            border-color: var(--terracotta);
        }
        .filter-select {
            padding-right: 28px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%239896A8' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            cursor: pointer;
        }
        .filter-input { width: 130px; }
        .filter-input[type="date"] { width: 150px; }
        .btn-filter-reset {
            background: none;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: inherit;
            font-size: 12px;
            padding: 7px 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-filter-reset:hover { color: var(--text-primary); border-color: var(--text-muted); }

        /* ===== GRID LAYOUTS ===== */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .grid-3-1 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ===== FUNNEL ===== */
        .funnel-stages {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 200px;
            padding: 0 20px;
        }
        .funnel-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        .funnel-bar-wrap {
            width: 100%;
            height: 160px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .funnel-bar {
            width: 80%;
            max-width: 80px;
            border-radius: 6px 6px 2px 2px;
            transition: height 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
            min-height: 4px;
        }
        .funnel-bar::after {
            content: attr(data-count);
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .funnel-stage:nth-child(1) .funnel-bar { background: linear-gradient(to top, var(--terracotta), var(--terracotta-light)); }
        .funnel-stage:nth-child(2) .funnel-bar { background: linear-gradient(to top, var(--amber), var(--amber-light)); }
        .funnel-stage:nth-child(3) .funnel-bar { background: linear-gradient(to top, #7e59e4, #9b7eed); }
        .funnel-stage:nth-child(4) .funnel-bar { background: linear-gradient(to top, var(--accent), #e8ec7e); }
        .funnel-stage:nth-child(5) .funnel-bar { background: linear-gradient(to top, var(--green), #7ee4b3); }
        .funnel-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.3;
        }
        .funnel-drop {
            font-size: 11px;
            color: var(--red);
            font-weight: 600;
            position: absolute;
            right: -18px;
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
        }

        /* ===== CHARTS ===== */
        .bar-chart { display: flex; flex-direction: column; gap: 10px; }
        .bar-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .bar-label {
            font-size: 12px;
            color: var(--text-secondary);
            width: 140px;
            text-align: right;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bar-track {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            min-width: 2px;
        }
        .bar-count {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            width: 40px;
            flex-shrink: 0;
        }

        /* Donut chart */
        .donut-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            padding: 10px 0;
        }
        .donut-svg { width: 140px; height: 140px; }
        .donut-legend { display: flex; flex-direction: column; gap: 10px; }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .legend-dot {
            width: 10px; height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-val {
            font-weight: 600;
            color: var(--text-primary);
            margin-left: auto;
            padding-left: 12px;
        }

        /* ===== EVENTS TABLE ===== */
        .table-wrap {
            overflow-x: auto;
            max-height: 480px;
            overflow-y: auto;
            border-radius: var(--radius-sm);
        }
        .events-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .events-table thead { position: sticky; top: 0; z-index: 2; }
        .events-table th {
            background: var(--navy-mid);
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .events-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .events-table tbody tr {
            transition: background 0.15s;
            cursor: pointer;
        }
        .events-table tbody tr:hover { background: rgba(255,255,255,0.02); }
        .events-table tbody tr.expanded { background: rgba(228,89,219,0.04); }
        .event-name-cell {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .event-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .event-name {
            font-weight: 500;
            color: var(--text-primary);
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
        }
        .role-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .role-tag.creator { background: rgba(228,89,219,0.15); color: var(--terracotta-light); }
        .role-tag.joiner { background: rgba(181,89,228,0.15); color: var(--amber-light); }
        .device-tag {
            font-size: 11px;
            color: var(--text-muted);
        }
        .params-row td {
            padding: 0 14px 12px 44px;
            white-space: normal;
            max-width: none;
            border-bottom: 1px solid var(--border);
        }
        .params-row { display: none; }
        .params-row.visible { display: table-row; }
        .params-json {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 11px;
            color: var(--text-muted);
            background: rgba(0,0,0,0.15);
            padding: 10px 14px;
            border-radius: 6px;
            line-height: 1.6;
            word-break: break-all;
            white-space: pre-wrap;
        }

        /* ===== IMPORT PANEL ===== */
        .import-panel {
            margin-bottom: 28px;
        }
        .import-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            padding: 8px 0;
            transition: color 0.2s;
        }
        .import-toggle:hover { color: var(--text-primary); }
        .import-toggle svg { width: 16px; height: 16px; transition: transform 0.3s; }
        .import-toggle.open svg { transform: rotate(90deg); }
        .import-body {
            display: none;
            margin-top: 12px;
        }
        .import-body.visible { display: block; }
        .import-textarea {
            width: 100%;
            min-height: 120px;
            background: var(--navy-surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            padding: 14px;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
            line-height: 1.6;
        }
        .import-textarea:focus { border-color: var(--terracotta); }
        .import-textarea::placeholder { color: var(--text-muted); }
        .import-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-import {
            padding: 8px 20px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-import.primary {
            background: linear-gradient(135deg, var(--terracotta), var(--amber));
            color: #fff;
        }
        .btn-import.primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-import.secondary {
            background: var(--navy-light);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        .btn-import.secondary:hover { color: var(--text-primary); }

        /* ===== STATUS MESSAGES ===== */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 20px;
            transition: all 0.3s;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }
        .status-bar.visible {
            opacity: 1;
            max-height: 60px;
            padding: 10px 16px;
        }
        .status-bar.info { background: rgba(181,89,228,0.1); border: 1px solid rgba(181,89,228,0.2); color: var(--amber-light); }
        .status-bar.success { background: rgba(89,228,160,0.1); border: 1px solid rgba(89,228,160,0.2); color: var(--green); }
        .status-bar.error { background: rgba(228,89,104,0.1); border: 1px solid rgba(228,89,104,0.2); color: var(--red); }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state svg {
            width: 48px; height: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        .empty-state p { font-size: 14px; line-height: 1.6; }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            opacity: 0;
        }
        .delay-1 { animation-delay: 0.05s; }
        .delay-2 { animation-delay: 0.1s; }
        .delay-3 { animation-delay: 0.15s; }
        .delay-4 { animation-delay: 0.2s; }
        .delay-5 { animation-delay: 0.25s; }
        .delay-6 { animation-delay: 0.3s; }
        .delay-7 { animation-delay: 0.35s; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .grid-2, .grid-3-1 { grid-template-columns: 1fr; }
            .funnel-stages { height: 160px; }
        }
        @media (max-width: 640px) {
            .dashboard { padding: 0 14px 40px; }
            .kpi-row { grid-template-columns: 1fr; }
            .header { padding: 16px 0; }
            .header-title { font-size: 16px; }
            .kpi-value { font-size: 26px; }
            .funnel-stages { flex-direction: column; height: auto; gap: 8px; align-items: stretch; }
            .funnel-bar-wrap { height: 28px; width: 100%; }
            .funnel-bar { width: 100% !important; max-width: none; height: 100%; border-radius: 4px; }
            .funnel-bar::after { top: 50%; right: 8px; left: auto; transform: translateY(-50%); }
            .funnel-drop { display: none; }
            .donut-wrap { flex-direction: column; }
            .filters-bar { gap: 8px; }
            .bar-label { width: 100px; font-size: 11px; }
        }

        /* ===== LAST REFRESH ===== */
        .last-refresh {
            font-size: 11px;
            color: var(--text-muted);
            text-align: right;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="noise"></div>

    <div class="dashboard">
        <!-- HEADER -->
        <header class="header animate-in">
            <div class="header-left">
                <div class="logo-mark">B</div>
                <h1 class="header-title">Baiddy <span>Analytics</span></h1>
            </div>
            <div class="header-right">
                <div class="live-badge" id="liveBadge" onclick="toggleLive()">
                    <div class="live-dot"></div>
                    <span id="liveLabel">Live</span>
                </div>
                <button class="btn-refresh" id="btnRefresh" onclick="loadData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    Aggiorna
                </button>
            </div>
        </header>

        <!-- STATUS -->
        <div class="status-bar" id="statusBar"></div>

        <!-- IMPORT FALLBACK -->
        <div class="import-panel animate-in delay-1">
            <button class="import-toggle" id="importToggle" onclick="toggleImport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
                Importa dati manualmente (JSON)
            </button>
            <div class="import-body" id="importBody">
                <textarea class="import-textarea" id="importTextarea" placeholder='Incolla qui i dati JSON dal Google Sheet...&#10;&#10;Formato: array di oggetti con campi: timestamp, session, event, role, source, device, elapsed, params&#10;&#10;[{"timestamp":"...","session":"...","event":"flow_open","role":"","source":"hero_cta","device":"mobile","elapsed":0,"params":{}}]'></textarea>
                <div class="import-actions">
                    <button class="btn-import primary" onclick="importJSON()">Importa</button>
                    <button class="btn-import secondary" onclick="loadSampleData()">Carica dati demo</button>
                </div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters-bar animate-in delay-2">
            <div class="filter-group">
                <span class="filter-label">Da</span>
                <input type="date" class="filter-input" id="filterDateFrom">
            </div>
            <div class="filter-group">
                <span class="filter-label">A</span>
                <input type="date" class="filter-input" id="filterDateTo">
            </div>
            <div class="filter-group">
                <select class="filter-select" id="filterEvent">
                    <option value="">Tutti gli eventi</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="filter-select" id="filterRole">
                    <option value="">Tutti i ruoli</option>
                    <option value="creator">Creator</option>
                    <option value="joiner">Joiner</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="filter-select" id="filterSource">
                    <option value="">Tutte le sorgenti</option>
                    <option value="hero_cta">Hero CTA</option>
                    <option value="nav_cta">Nav CTA</option>
                    <option value="bottom_cta">Bottom CTA</option>
                    <option value="featured_card">Card in evidenza</option>
                    <option value="featured_section">Sezione in evidenza</option>
                </select>
            </div>
            <div class="filter-group">
                <select class="filter-select" id="filterDevice">
                    <option value="">Tutti i device</option>
                    <option value="mobile">Mobile</option>
                    <option value="tablet">Tablet</option>
                    <option value="desktop">Desktop</option>
                </select>
            </div>
            <button class="btn-filter-reset" onclick="resetFilters()">Reset</button>
        </div>

        <!-- KPI ROW -->
        <div class="kpi-row animate-in delay-3">
            <div class="kpi-card">
                <div class="kpi-label">Sessioni totali</div>
                <div class="kpi-value" id="kpiSessions">—</div>
                <div class="kpi-sub" id="kpiSessionsSub"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Eventi totali</div>
                <div class="kpi-value" id="kpiEvents">—</div>
                <div class="kpi-sub" id="kpiEventsSub"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Tasso conversione</div>
                <div class="kpi-value" id="kpiConversion">—</div>
                <div class="kpi-sub" id="kpiConversionSub"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Durata media sessione</div>
                <div class="kpi-value" id="kpiDuration">—</div>
                <div class="kpi-sub" id="kpiDurationSub"></div>
            </div>
        </div>

        <!-- FUNNEL + ROLE SPLIT -->
        <div class="grid-3-1 animate-in delay-4">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Funnel di conversione</h2>
                    <span class="panel-badge" id="funnelBadge">—</span>
                </div>
                <div class="funnel-stages" id="funnelChart"></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Ruoli</h2>
                </div>
                <div class="donut-wrap" id="roleChart">
                    <div class="empty-state"><p>Nessun dato</p></div>
                </div>
            </div>
        </div>

        <!-- CHARTS ROW -->
        <div class="grid-2 animate-in delay-5">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Eventi per tipo</h2>
                </div>
                <div class="bar-chart" id="eventTypeChart"></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Sorgenti</h2>
                </div>
                <div class="bar-chart" id="sourceChart"></div>
            </div>
        </div>

        <div class="grid-2 animate-in delay-6">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Dispositivi</h2>
                </div>
                <div class="donut-wrap" id="deviceChart">
                    <div class="empty-state"><p>Nessun dato</p></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Città selezionate</h2>
                </div>
                <div class="bar-chart" id="cityChart"></div>
            </div>
        </div>

        <!-- EVENTS LOG -->
        <div class="panel animate-in delay-7">
            <div class="panel-header">
                <h2 class="panel-title">Log eventi</h2>
                <span class="panel-badge" id="eventsCount">0 eventi</span>
            </div>
            <div class="last-refresh" id="lastRefresh"></div>
            <div class="table-wrap">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Sessione</th>
                            <th>Evento</th>
                            <th>Ruolo</th>
                            <th>Sorgente</th>
                            <th>Device</th>
                            <th>Elapsed</th>
                        </tr>
                    </thead>
                    <tbody id="eventsBody"></tbody>
                </table>
            </div>
            <div class="empty-state" id="eventsEmpty" style="display:none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                <p>Nessun evento trovato.<br>Carica dati dal webhook o importa manualmente.</p>
            </div>
        </div>
    </div>

    <script>
    // ===== STATE =====
    var allEvents = [];
    var filteredEvents = [];
    var liveMode = false;
    var liveInterval = null;
    var WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbwzv78zohN8NMcTjSmenM4BPHqvfczJ_dKr0509ire9XgnPsOVsmj0ChWJZAPphaO31IA/exec';

    // ===== EVENT COLORS =====
    var eventColors = {
        flow_open: '#e459db',
        flow_close: '#e45968',
        role_selected: '#b559e4',
        creator_city_selected: '#59b5e4',
        creator_step_stops: '#59b5e4',
        creator_stop_added: '#59e4a0',
        creator_stop_removed: '#e4a059',
        creator_step_preview: '#59e4d5',
        joiner_step_browse: '#c97eed',
        joiner_roadmap_selected: '#9b7eed',
        lead_step_reached: '#dbe459',
        lead_toggle: '#e4d559',
        lead_submitted: '#59e4a0',
        flow_completed: '#59e4a0'
    };

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function() {
        setupFilterListeners();
        loadData();
    });

    // ===== DATA LOADING =====
    function loadData() {
        var btn = document.getElementById('btnRefresh');
        btn.classList.add('loading');
        showStatus('info', 'Caricamento dati dal webhook...');

        fetch(WEBHOOK_URL + '?action=read', { method: 'GET' })
            .then(function(res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.text();
            })
            .then(function(text) {
                btn.classList.remove('loading');
                // Try parsing as JSON
                var data;
                try { data = JSON.parse(text); } catch(e) { data = null; }

                if (data && Array.isArray(data)) {
                    allEvents = normalizeEvents(data);
                    showStatus('success', 'Caricati ' + allEvents.length + ' eventi dal webhook.');
                    applyFilters();
                } else if (data && data.data && Array.isArray(data.data)) {
                    allEvents = normalizeEvents(data.data);
                    showStatus('success', 'Caricati ' + allEvents.length + ' eventi dal webhook.');
                    applyFilters();
                } else {
                    // Webhook returned non-JSON (e.g. "Webhook attivo")
                    showStatus('info', 'Webhook connesso. Per visualizzare i dati, esporta il Google Sheet in JSON e incollalo qui sotto, oppure carica i dati demo.');
                    openImportPanel();
                }
            })
            .catch(function(err) {
                btn.classList.remove('loading');
                showStatus('error', 'Impossibile connettersi al webhook (' + err.message + '). Usa l\'importazione manuale o carica i dati demo.');
                openImportPanel();
                console.warn('Fetch error:', err);
            });

        updateLastRefresh();
    }

    function openImportPanel() {
        var toggle = document.getElementById('importToggle');
        var body = document.getElementById('importBody');
        if (!body.classList.contains('visible')) {
            toggle.classList.add('open');
            body.classList.add('visible');
        }
    }

    function normalizeEvents(data) {
        return data.map(function(e) {
            var params = e.params;
            if (typeof params === 'string') {
                try { params = JSON.parse(params); } catch(x) { params = {}; }
            }
            return {
                timestamp: e.timestamp || e.Timestamp || '',
                session: e.session || e.Session || '',
                event: e.event || e.Event || '',
                role: e.role || e.Role || '',
                source: e.source || e.Source || '',
                device: e.device || e.Device || '',
                elapsed: parseInt(e.elapsed || e.Elapsed || 0) || 0,
                params: params || {}
            };
        }).sort(function(a, b) {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
    }

    // ===== IMPORT =====
    function toggleImport() {
        var toggle = document.getElementById('importToggle');
        var body = document.getElementById('importBody');
        toggle.classList.toggle('open');
        body.classList.toggle('visible');
    }

    function importJSON() {
        var raw = document.getElementById('importTextarea').value.trim();
        if (!raw) { showStatus('error', 'Incolla dei dati JSON prima di importare.'); return; }
        try {
            var data = JSON.parse(raw);
            if (!Array.isArray(data)) data = [data];
            allEvents = normalizeEvents(data);
            showStatus('success', 'Importati ' + allEvents.length + ' eventi.');
            applyFilters();
        } catch(e) {
            showStatus('error', 'JSON non valido: ' + e.message);
        }
    }

    function loadSampleData() {
        var sessions = ['abc123', 'def456', 'ghi789', 'jkl012', 'mno345', 'pqr678', 'stu901', 'vwx234'];
        var sources = ['hero_cta', 'nav_cta', 'bottom_cta', 'featured_card', 'featured_section'];
        var devices = ['mobile', 'mobile', 'mobile', 'desktop', 'desktop', 'tablet'];
        var cities = ['Milano', 'Roma', 'Napoli', 'Firenze'];
        var categories = ['Food', 'Cultura', 'Nightlife', 'Shopping', 'Natura'];
        var roadmaps = [
            { id: 1, title: 'Sapori di Trastevere' },
            { id: 2, title: 'Milano by Night' },
            { id: 3, title: 'Street Art Tour Napoli' },
            { id: 4, title: 'Firenze Artigianale' }
        ];
        var sample = [];
        var baseTime = new Date();
        baseTime.setDate(baseTime.getDate() - 7);

        for (var s = 0; s < sessions.length; s++) {
            var sid = sessions[s];
            var src = sources[s % sources.length];
            var dev = devices[s % devices.length];
            var isCreator = s % 3 !== 2;
            var role = isCreator ? 'creator' : 'joiner';
            var t = new Date(baseTime.getTime() + s * 3600000 * (4 + Math.random() * 8));
            var elapsed = 0;

            sample.push({ timestamp: t.toISOString(), session: sid, event: 'flow_open', role: '', source: src, device: dev, elapsed: 0, params: { source: src } });
            elapsed += 3 + Math.floor(Math.random() * 5);
            t = new Date(t.getTime() + elapsed * 1000);

            sample.push({ timestamp: t.toISOString(), session: sid, event: 'role_selected', role: role, source: src, device: dev, elapsed: elapsed, params: { role: role, source: src } });
            elapsed += 2 + Math.floor(Math.random() * 4);
            t = new Date(t.getTime() + 2000);

            if (isCreator) {
                var city = cities[s % cities.length];
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'creator_city_selected', role: 'creator', source: src, device: dev, elapsed: elapsed, params: { city: city } });
                elapsed += 3;
                t = new Date(t.getTime() + 3000);

                sample.push({ timestamp: t.toISOString(), session: sid, event: 'creator_step_stops', role: 'creator', source: src, device: dev, elapsed: elapsed, params: { city: city } });
                elapsed += 5;
                t = new Date(t.getTime() + 5000);

                var numStops = 2 + Math.floor(Math.random() * 3);
                for (var st = 0; st < numStops; st++) {
                    sample.push({ timestamp: t.toISOString(), session: sid, event: 'creator_stop_added', role: 'creator', source: src, device: dev, elapsed: elapsed, params: { stop_name: 'Stop ' + (st + 1), category: categories[st % categories.length], stop_count: st + 1 } });
                    elapsed += 4;
                    t = new Date(t.getTime() + 4000);
                }

                sample.push({ timestamp: t.toISOString(), session: sid, event: 'creator_step_preview', role: 'creator', source: src, device: dev, elapsed: elapsed, params: { city: city, stop_count: numStops } });
                elapsed += 3;
                t = new Date(t.getTime() + 3000);
            } else {
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'joiner_step_browse', role: 'joiner', source: src, device: dev, elapsed: elapsed, params: {} });
                elapsed += 6;
                t = new Date(t.getTime() + 6000);

                var rm = roadmaps[s % roadmaps.length];
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'joiner_roadmap_selected', role: 'joiner', source: src, device: dev, elapsed: elapsed, params: { roadmap_id: rm.id, roadmap_title: rm.title } });
                elapsed += 4;
                t = new Date(t.getTime() + 4000);
            }

            // Some sessions drop off
            if (s === 2) {
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'flow_close', role: role, source: src, device: dev, elapsed: elapsed, params: { step: 'stepStops', role: role, source: src } });
                continue;
            }

            sample.push({ timestamp: t.toISOString(), session: sid, event: 'lead_step_reached', role: role, source: src, device: dev, elapsed: elapsed, params: { role: role, source: src } });
            elapsed += 2;
            t = new Date(t.getTime() + 2000);

            // Some switch toggle
            if (s % 4 === 0) {
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'lead_toggle', role: role, source: src, device: dev, elapsed: elapsed, params: { type: 'whatsapp' } });
                elapsed += 1;
                t = new Date(t.getTime() + 1000);
            }

            // Another drop-off
            if (s === 5) {
                sample.push({ timestamp: t.toISOString(), session: sid, event: 'flow_close', role: role, source: src, device: dev, elapsed: elapsed, params: { step: 'stepLead', role: role, source: src } });
                continue;
            }

            var leadType = (s % 4 === 0) ? 'whatsapp' : 'email';
            var contact = leadType === 'email' ? 'user' + s + '@example.com' : '+39 333 ' + (1000000 + s);
            sample.push({ timestamp: t.toISOString(), session: sid, event: 'lead_submitted', role: role, source: src, device: dev, elapsed: elapsed, params: { role: role, lead_type: leadType, contact: contact, source: src } });
            elapsed += 2;
            t = new Date(t.getTime() + 2000);

            sample.push({ timestamp: t.toISOString(), session: sid, event: 'flow_completed', role: role, source: src, device: dev, elapsed: elapsed, params: { role: role, source: src } });
        }

        allEvents = normalizeEvents(sample);
        showStatus('success', 'Caricati ' + allEvents.length + ' eventi demo.');
        applyFilters();
    }

    // ===== FILTERS =====
    function setupFilterListeners() {
        ['filterEvent', 'filterRole', 'filterSource', 'filterDevice'].forEach(function(id) {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
        ['filterDateFrom', 'filterDateTo'].forEach(function(id) {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
    }

    function resetFilters() {
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterEvent').value = '';
        document.getElementById('filterRole').value = '';
        document.getElementById('filterSource').value = '';
        document.getElementById('filterDevice').value = '';
        applyFilters();
    }

    function applyFilters() {
        var dateFrom = document.getElementById('filterDateFrom').value;
        var dateTo = document.getElementById('filterDateTo').value;
        var eventFilter = document.getElementById('filterEvent').value;
        var roleFilter = document.getElementById('filterRole').value;
        var sourceFilter = document.getElementById('filterSource').value;
        var deviceFilter = document.getElementById('filterDevice').value;

        filteredEvents = allEvents.filter(function(e) {
            if (dateFrom && e.timestamp < dateFrom) return false;
            if (dateTo && e.timestamp < dateTo + 'T23:59:59') {
                // include events on the dateTo day
            }
            if (dateTo && e.timestamp > dateTo + 'T23:59:59.999Z') return false;
            if (eventFilter && e.event !== eventFilter) return false;
            if (roleFilter && e.role !== roleFilter) return false;
            if (sourceFilter && e.source !== sourceFilter) return false;
            if (deviceFilter && e.device !== deviceFilter) return false;
            return true;
        });

        populateEventFilter();
        renderAll();
    }

    function populateEventFilter() {
        var select = document.getElementById('filterEvent');
        var current = select.value;
        var types = {};
        allEvents.forEach(function(e) { if (e.event) types[e.event] = true; });
        var sorted = Object.keys(types).sort();

        select.innerHTML = '<option value="">Tutti gli eventi</option>';
        sorted.forEach(function(t) {
            var opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            if (t === current) opt.selected = true;
            select.appendChild(opt);
        });
    }

    // ===== RENDER ALL =====
    function renderAll() {
        renderKPIs();
        renderFunnel();
        renderEventTypeChart();
        renderSourceChart();
        renderRoleChart();
        renderDeviceChart();
        renderCityChart();
        renderEventsTable();
    }

    // ===== KPIs =====
    function renderKPIs() {
        var events = filteredEvents;
        var sessionSet = {};
        events.forEach(function(e) { if (e.session) sessionSet[e.session] = true; });
        var totalSessions = Object.keys(sessionSet).length;
        var totalEvents = events.length;

        var flowOpens = events.filter(function(e) { return e.event === 'flow_open'; }).length;
        var leadSubmits = events.filter(function(e) { return e.event === 'lead_submitted'; }).length;
        var convRate = flowOpens > 0 ? ((leadSubmits / flowOpens) * 100).toFixed(1) : '0';

        // Avg duration: max elapsed per session
        var sessionDurations = {};
        events.forEach(function(e) {
            if (e.session && e.elapsed) {
                if (!sessionDurations[e.session] || e.elapsed > sessionDurations[e.session]) {
                    sessionDurations[e.session] = e.elapsed;
                }
            }
        });
        var durations = Object.values(sessionDurations);
        var avgDuration = durations.length > 0 ? Math.round(durations.reduce(function(a, b) { return a + b; }, 0) / durations.length) : 0;

        document.getElementById('kpiSessions').textContent = totalSessions;
        document.getElementById('kpiSessionsSub').textContent = totalSessions === 1 ? '1 sessione unica' : totalSessions + ' sessioni uniche';
        document.getElementById('kpiEvents').textContent = totalEvents;
        document.getElementById('kpiEventsSub').textContent = totalSessions > 0 ? (totalEvents / totalSessions).toFixed(1) + ' eventi/sessione' : '';
        document.getElementById('kpiConversion').textContent = convRate + '%';
        document.getElementById('kpiConversionSub').textContent = leadSubmits + ' lead su ' + flowOpens + ' aperture';
        document.getElementById('kpiDuration').textContent = formatDuration(avgDuration);
        document.getElementById('kpiDurationSub').textContent = durations.length + ' sessioni misurate';
    }

    function formatDuration(secs) {
        if (secs < 60) return secs + 's';
        var m = Math.floor(secs / 60);
        var s = secs % 60;
        return m + 'm ' + s + 's';
    }

    // ===== FUNNEL =====
    function renderFunnel() {
        var events = filteredEvents;
        var stages = [
            { key: 'flow_open', label: 'Flow aperto' },
            { key: 'role_selected', label: 'Ruolo scelto' },
            { key: 'lead_step_reached', label: 'Step lead' },
            { key: 'lead_submitted', label: 'Lead inviato' },
            { key: 'flow_completed', label: 'Completato' }
        ];

        // Count unique sessions per stage
        var stageCounts = stages.map(function(s) {
            var sessions = {};
            events.forEach(function(e) {
                if (e.event === s.key && e.session) sessions[e.session] = true;
            });
            return Object.keys(sessions).length;
        });

        var maxCount = Math.max.apply(null, stageCounts.concat([1]));
        var container = document.getElementById('funnelChart');
        container.innerHTML = '';

        stages.forEach(function(s, i) {
            var count = stageCounts[i];
            var pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
            var heightPct = Math.max(pct, 3);
            var dropPct = i > 0 && stageCounts[i - 1] > 0
                ? '-' + Math.round((1 - count / stageCounts[i - 1]) * 100) + '%'
                : '';

            var stage = document.createElement('div');
            stage.className = 'funnel-stage';
            stage.innerHTML =
                '<div class="funnel-bar-wrap">' +
                    '<div class="funnel-bar" style="height:' + heightPct + '%" data-count="' + count + '"></div>' +
                '</div>' +
                '<div class="funnel-label">' + s.label + '</div>' +
                (dropPct ? '<div class="funnel-drop">' + dropPct + '</div>' : '');
            container.appendChild(stage);
        });

        var totalOpen = stageCounts[0];
        var totalComplete = stageCounts[4];
        var overallRate = totalOpen > 0 ? Math.round((totalComplete / totalOpen) * 100) : 0;
        document.getElementById('funnelBadge').textContent = overallRate + '% completamento';
    }

    // ===== BAR CHARTS =====
    function renderBarChart(containerId, data, colorFn) {
        var container = document.getElementById(containerId);
        var maxVal = Math.max.apply(null, data.map(function(d) { return d.count; }).concat([1]));
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>Nessun dato</p></div>';
            return;
        }

        data.forEach(function(d) {
            var pct = (d.count / maxVal) * 100;
            var color = colorFn ? colorFn(d.label) : 'var(--terracotta)';
            var row = document.createElement('div');
            row.className = 'bar-row';
            row.innerHTML =
                '<span class="bar-label" title="' + d.label + '">' + d.label + '</span>' +
                '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>' +
                '<span class="bar-count">' + d.count + '</span>';
            container.appendChild(row);
        });
    }

    function renderEventTypeChart() {
        var counts = {};
        filteredEvents.forEach(function(e) {
            counts[e.event] = (counts[e.event] || 0) + 1;
        });
        var data = Object.keys(counts).map(function(k) {
            return { label: k, count: counts[k] };
        }).sort(function(a, b) { return b.count - a.count; });

        renderBarChart('eventTypeChart', data, function(label) {
            return eventColors[label] || '#888';
        });
    }

    function renderSourceChart() {
        var counts = {};
        filteredEvents.forEach(function(e) {
            if (e.source) counts[e.source] = (counts[e.source] || 0) + 1;
        });
        var data = Object.keys(counts).map(function(k) {
            return { label: k, count: counts[k] };
        }).sort(function(a, b) { return b.count - a.count; });

        var colors = { hero_cta: '#e459db', nav_cta: '#b559e4', bottom_cta: '#dbe459', featured_card: '#59e4a0', featured_section: '#59b5e4' };
        renderBarChart('sourceChart', data, function(label) {
            return colors[label] || '#888';
        });
    }

    function renderCityChart() {
        var counts = {};
        filteredEvents.forEach(function(e) {
            var city = e.params && e.params.city;
            if (city) counts[city] = (counts[city] || 0) + 1;
        });
        var data = Object.keys(counts).map(function(k) {
            return { label: k, count: counts[k] };
        }).sort(function(a, b) { return b.count - a.count; });

        var colors = { Milano: '#59b5e4', Roma: '#e459db', Napoli: '#e4a059', Firenze: '#59e4a0' };
        renderBarChart('cityChart', data, function(label) {
            return colors[label] || '#888';
        });
    }

    // ===== DONUT CHARTS =====
    function renderDonut(containerId, segments, totalLabel) {
        var container = document.getElementById(containerId);
        var total = segments.reduce(function(a, s) { return a + s.count; }, 0);

        if (total === 0) {
            container.innerHTML = '<div class="empty-state"><p>Nessun dato</p></div>';
            return;
        }

        var svgSize = 140;
        var radius = 52;
        var stroke = 18;
        var circumference = 2 * Math.PI * radius;
        var offset = 0;

        var paths = segments.map(function(seg) {
            var pct = seg.count / total;
            var dashLen = pct * circumference;
            var dashOffset = -offset;
            offset += dashLen;
            return '<circle cx="' + (svgSize / 2) + '" cy="' + (svgSize / 2) + '" r="' + radius + '" ' +
                'fill="none" stroke="' + seg.color + '" stroke-width="' + stroke + '" ' +
                'stroke-dasharray="' + dashLen + ' ' + (circumference - dashLen) + '" ' +
                'stroke-dashoffset="' + dashOffset + '" ' +
                'style="transition: stroke-dasharray 0.8s ease, stroke-dashoffset 0.8s ease;" />';
        }).join('');

        var legendItems = segments.map(function(seg) {
            var pct = total > 0 ? Math.round((seg.count / total) * 100) : 0;
            return '<div class="legend-item">' +
                '<div class="legend-dot" style="background:' + seg.color + '"></div>' +
                '<span>' + seg.label + '</span>' +
                '<span class="legend-val">' + seg.count + ' (' + pct + '%)</span>' +
            '</div>';
        }).join('');

        container.innerHTML =
            '<svg class="donut-svg" viewBox="0 0 ' + svgSize + ' ' + svgSize + '">' +
                '<circle cx="' + (svgSize / 2) + '" cy="' + (svgSize / 2) + '" r="' + radius + '" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="' + stroke + '" />' +
                paths +
                '<text x="' + (svgSize / 2) + '" y="' + (svgSize / 2 - 4) + '" text-anchor="middle" fill="' + 'var(--text-primary)' + '" font-size="20" font-weight="700" font-family="Aeonik, sans-serif">' + total + '</text>' +
                '<text x="' + (svgSize / 2) + '" y="' + (svgSize / 2 + 14) + '" text-anchor="middle" fill="' + 'var(--text-muted)' + '" font-size="10" font-family="Aeonik, sans-serif">' + (totalLabel || 'totale') + '</text>' +
            '</svg>' +
            '<div class="donut-legend">' + legendItems + '</div>';
    }

    function renderRoleChart() {
        var roleSessions = { creator: {}, joiner: {} };
        filteredEvents.forEach(function(e) {
            if (e.role === 'creator' && e.session) roleSessions.creator[e.session] = true;
            if (e.role === 'joiner' && e.session) roleSessions.joiner[e.session] = true;
        });
        renderDonut('roleChart', [
            { label: 'Creator', count: Object.keys(roleSessions.creator).length, color: '#e459db' },
            { label: 'Joiner', count: Object.keys(roleSessions.joiner).length, color: '#b559e4' }
        ], 'sessioni');
    }

    function renderDeviceChart() {
        var deviceSessions = {};
        filteredEvents.forEach(function(e) {
            if (e.device && e.session) {
                if (!deviceSessions[e.device]) deviceSessions[e.device] = {};
                deviceSessions[e.device][e.session] = true;
            }
        });
        var deviceColors = { mobile: '#e459db', tablet: '#dbe459', desktop: '#59e4a0' };
        var segments = Object.keys(deviceSessions).map(function(d) {
            return { label: d.charAt(0).toUpperCase() + d.slice(1), count: Object.keys(deviceSessions[d]).length, color: deviceColors[d] || '#888' };
        });
        renderDonut('deviceChart', segments, 'sessioni');
    }

    // ===== EVENTS TABLE =====
    function renderEventsTable() {
        var tbody = document.getElementById('eventsBody');
        var emptyEl = document.getElementById('eventsEmpty');
        var countEl = document.getElementById('eventsCount');
        tbody.innerHTML = '';

        if (filteredEvents.length === 0) {
            emptyEl.style.display = 'block';
            countEl.textContent = '0 eventi';
            return;
        }

        emptyEl.style.display = 'none';
        countEl.textContent = filteredEvents.length + ' eventi';

        filteredEvents.forEach(function(e, idx) {
            var tr = document.createElement('tr');
            tr.setAttribute('data-idx', idx);
            tr.onclick = function() { toggleParams(idx); };

            var ts = e.timestamp ? formatTimestamp(e.timestamp) : '—';
            var sessionShort = e.session ? e.session.substring(0, 8) : '—';
            var color = eventColors[e.event] || '#888';
            var roleHtml = '';
            if (e.role === 'creator') roleHtml = '<span class="role-tag creator">Creator</span>';
            else if (e.role === 'joiner') roleHtml = '<span class="role-tag joiner">Joiner</span>';
            else roleHtml = '<span style="color:var(--text-muted)">—</span>';

            tr.innerHTML =
                '<td>' + ts + '</td>' +
                '<td style="font-family:monospace;font-size:11px;color:var(--text-muted)">' + sessionShort + '</td>' +
                '<td><span class="event-name-cell"><span class="event-dot" style="background:' + color + '"></span><span class="event-name">' + escapeHtml(e.event) + '</span></span></td>' +
                '<td>' + roleHtml + '</td>' +
                '<td>' + escapeHtml(e.source || '—') + '</td>' +
                '<td><span class="device-tag">' + escapeHtml(e.device || '—') + '</span></td>' +
                '<td>' + e.elapsed + 's</td>';
            tbody.appendChild(tr);

            // Params expandable row
            var paramsTr = document.createElement('tr');
            paramsTr.className = 'params-row';
            paramsTr.id = 'params-' + idx;
            paramsTr.innerHTML = '<td colspan="7"><div class="params-json">' + escapeHtml(JSON.stringify(e.params, null, 2)) + '</div></td>';
            tbody.appendChild(paramsTr);
        });
    }

    function toggleParams(idx) {
        var row = document.getElementById('params-' + idx);
        var mainRow = document.querySelector('tr[data-idx="' + idx + '"]');
        if (row) {
            row.classList.toggle('visible');
            mainRow.classList.toggle('expanded');
        }
    }

    function formatTimestamp(ts) {
        try {
            var d = new Date(ts);
            var day = String(d.getDate()).padStart(2, '0');
            var month = String(d.getMonth() + 1).padStart(2, '0');
            var hours = String(d.getHours()).padStart(2, '0');
            var mins = String(d.getMinutes()).padStart(2, '0');
            var secs = String(d.getSeconds()).padStart(2, '0');
            return day + '/' + month + ' ' + hours + ':' + mins + ':' + secs;
        } catch(e) { return ts; }
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ===== LIVE MODE =====
    function toggleLive() {
        liveMode = !liveMode;
        var badge = document.getElementById('liveBadge');
        var label = document.getElementById('liveLabel');
        if (liveMode) {
            badge.classList.remove('inactive');
            label.textContent = 'Live';
            liveInterval = setInterval(loadData, 30000);
        } else {
            badge.classList.add('inactive');
            label.textContent = 'Pausa';
            if (liveInterval) { clearInterval(liveInterval); liveInterval = null; }
        }
    }

    // ===== STATUS =====
    function showStatus(type, message) {
        var bar = document.getElementById('statusBar');
        bar.className = 'status-bar ' + type + ' visible';
        bar.textContent = message;
        if (type !== 'error') {
            setTimeout(function() { bar.classList.remove('visible'); }, 4000);
        }
    }

    function updateLastRefresh() {
        var el = document.getElementById('lastRefresh');
        var now = new Date();
        el.textContent = 'Ultimo aggiornamento: ' + now.toLocaleTimeString('it-IT');
    }
    </script>
</body>
</html>
